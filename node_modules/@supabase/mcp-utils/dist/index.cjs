"use strict";Object.defineProperty(exports, "__esModule", {value: true}); function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; } function _nullishCoalesce(lhs, rhsFn) { if (lhs != null) { return lhs; } else { return rhsFn(); } } function _optionalChain(ops) { let lastAccessLHS = undefined; let value = ops[0]; let i = 1; while (i < ops.length) { const op = ops[i]; const fn = ops[i + 1]; i += 2; if ((op === 'optionalAccess' || op === 'optionalCall') && value == null) { return undefined; } if (op === 'access' || op === 'optionalAccess') { lastAccessLHS = value; value = fn(value); } else if (op === 'call' || op === 'optionalCall') { value = fn((...args) => value.call(lastAccessLHS, ...args)); lastAccessLHS = undefined; } } return value; }var _indexjs = require('@modelcontextprotocol/sdk/server/index.js');var _typesjs = require('@modelcontextprotocol/sdk/types.js');require('zod');var _zodtojsonschema = require('zod-to-json-schema'); var _zodtojsonschema2 = _interopRequireDefault(_zodtojsonschema);function w(e){try{return new URL(e),e}catch (e2){throw new Error(`invalid uri: ${e}`)}}function x(e,t){let s=new URL(e),i=new URL(t);return s.href===i.href}function h(e,t){let i=new URL(e).pathname.split("/").slice(1);for(let u of t){let a=new URL(u),p=decodeURIComponent(a.pathname).split("/").slice(1);if(i.length!==p.length)continue;let o={},r=!0;for(let n=0;n<i.length;n++){let c=p[n],l=i[n];if(!c||!l)break;if(c.startsWith("{")&&c.endsWith("}")){let R=c.slice(1,-1);if(!R)break;o[R]=l}else if(i[n]!==p[n]){r=!1;break}}if(r)return{uri:u,params:o}}}function L(e,t){return{uri:e,...t}}function J(e,t){return{uriTemplate:e,...t}}function M(e,t){return{uri:e,mimeType:"application/json",...t}}function W(e,t){return{uriTemplate:e,mimeType:"application/json",...t}}function H(e,t){return t.map(s=>{if("uri"in s){let a=new URL(s.uri,`${e}://`),p=decodeURI(a.href);return{...s,uri:p}}let i=new URL(s.uriTemplate,`${e}://`),u=decodeURI(i.href);return{...s,uriTemplate:u}})}function A(e,t){return{uri:e,mimeType:"application/json",text:JSON.stringify(t)}}function V(e){return e}function Z(e){let t={};e.resources&&(t.resources={}),e.tools&&(t.tools={});let s=new (0, _indexjs.Server)({name:e.name,version:e.version},{capabilities:t}),i,u=new Promise(o=>{i=o});async function a(){let o=await u;if(!e.resources)throw new Error("resources not available");return typeof e.resources=="function"?await e.resources(o):e.resources}async function p(){let o=await u;if(!e.tools)throw new Error("tools not available");return typeof e.tools=="function"?await e.tools(o):e.tools}return s.oninitialized=async()=>{let o=s.getClientVersion(),r=s.getClientCapabilities();if(!o)throw new Error("client info not available after initialization");if(!r)throw new Error("client capabilities not available after initialization");let n={clientInfo:o,clientCapabilities:r};await _optionalChain([e, 'access', _ => _.onInitialize, 'optionalCall', _2 => _2(n)]),i(n)},e.resources&&(s.setRequestHandler(_typesjs.ListResourcesRequestSchema,async()=>({resources:(await a()).filter(r=>"uri"in r).map(({uri:r,name:n,description:c,mimeType:l})=>({uri:r,name:n,description:c,mimeType:l}))})),s.setRequestHandler(_typesjs.ListResourceTemplatesRequestSchema,async()=>({resourceTemplates:(await a()).filter(r=>"uriTemplate"in r).map(({uriTemplate:r,name:n,description:c,mimeType:l})=>({uriTemplate:r,name:n,description:c,mimeType:l}))})),s.setRequestHandler(_typesjs.ReadResourceRequestSchema,async o=>{try{let r=await a(),{uri:n}=o.params,l=r.filter(m=>"uri"in m).find(m=>x(m.uri,n));if(l)return await l.read(n);let R=r.filter(m=>"uriTemplate"in m),y=R.map(({uriTemplate:m})=>w(m)),f=h(n,y);if(!f)throw new Error("resource not found");let g=R.find(m=>m.uriTemplate===f.uri);if(!g)throw new Error("resource not found");let d=await g.read(n,f.params);return{contents:Array.isArray(d)?d:[d]}}catch(r){return{isError:!0,content:[{type:"text",text:JSON.stringify({error:T(r)})}]}}})),e.tools&&(s.setRequestHandler(_typesjs.ListToolsRequestSchema,async()=>{let o=await p();return{tools:Object.entries(o).map(([r,{description:n,parameters:c}])=>({name:r,description:n,inputSchema:_zodtojsonschema2.default.call(void 0, c)}))}}),s.setRequestHandler(_typesjs.CallToolRequestSchema,async o=>{try{let r=await p(),n=o.params.name;if(!(n in r))throw new Error("tool not found");let c=r[n];if(!c)throw new Error("tool not found");let l=c.parameters.strict().parse(_nullishCoalesce(o.params.arguments, () => ({}))),R=await c.execute(l);return{content:R?[{type:"text",text:JSON.stringify(R)}]:[]}}catch(r){return{isError:!0,content:[{type:"text",text:JSON.stringify({error:T(r)})}]}}})),s}function T(e){if(!e||typeof e!="object")return e;let t={},s=["name","message"];for(let i of s)i in e&&(t[i]=e[i]);return t}var S=class{#e;#t;constructor(){let t,s,i=new Promise(a=>{t=a}),u=new Promise(a=>{s=a});this.ready=Promise.all([i,u]).then(()=>{}),this.readable=new ReadableStream({start:a=>{this.#e=a,t()}}),this.writable=new WritableStream({start:a=>{this.#t=a,s()},write:a=>{_optionalChain([this, 'access', _3 => _3.onmessage, 'optionalCall', _4 => _4(a)])}})}async start(){await this.ready}async send(t){if(!this.#e)throw new Error("readable stream not initialized");this.#e.enqueue(t)}async close(){_optionalChain([this, 'access', _5 => _5.#e, 'optionalAccess', _6 => _6.error, 'call', _7 => _7(new Error("connection closed"))]),_optionalChain([this, 'access', _8 => _8.#t, 'optionalAccess', _9 => _9.error, 'call', _10 => _10(new Error("connection closed"))]),_optionalChain([this, 'access', _11 => _11.onclose, 'optionalCall', _12 => _12()])}};exports.StreamTransport = S; exports.createMcpServer = Z; exports.jsonResource = M; exports.jsonResourceResponse = A; exports.jsonResourceTemplate = W; exports.resource = L; exports.resourceTemplate = J; exports.resources = H; exports.tool = V;
//# sourceMappingURL=index.cjs.map